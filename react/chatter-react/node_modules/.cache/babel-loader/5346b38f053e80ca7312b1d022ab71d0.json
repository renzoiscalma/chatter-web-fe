{"ast":null,"code":"var _jsxFileName = \"/home/xeg/dev/chatter-web/frontend/react/chatter-react/src/components/Chatter/Chatter.tsx\",\n    _s = $RefreshSig$();\n\nimport { useContext, useEffect, useReducer, useState } from 'react';\nimport Box from '@mui/material/Box';\nimport { Divider } from '@mui/material';\nimport Messages from './Messages';\nimport Sender from './Sender';\nimport SendStatus from './interface/SendStatus';\nimport { useMutation, useQuery, useSubscription } from '@apollo/client';\nimport { GET_MESSAGES_ON_LOBBY, MESSAGE_ADDED_SUBSCRIPTION, SEND_MESSAGE } from '../Queries/Chatter';\nimport { UserContext } from '../Layout/Layout';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\n\nfunction sendMessageReducer(state, action) {\n  let messages = state;\n  console.log(action.payload);\n\n  switch (action.type) {\n    case \"FETCH_ALL\":\n      return action.payload.map(message => {\n        return {\n          date: new Date(+message.date),\n          message: message.message,\n          sender: message.from.id,\n          senderUsername: message.from.username,\n          to: \"Lobby\",\n          sendStatus: SendStatus.SENT\n        };\n      });\n\n    case SendStatus.FAILED:\n      return {};\n\n    case SendStatus.SENDING:\n      {\n        let {\n          to,\n          sender,\n          message,\n          localDateSent\n        } = action.payload;\n        messages.push(action.payload);\n        action.payload.callback({\n          variables: {\n            to,\n            from: sender,\n            message,\n            localDateSent\n          }\n        });\n        return [...messages];\n      }\n\n    case SendStatus.SENT:\n      {\n        let {\n          localDateSent,\n          sender\n        } = action.payload;\n        console.log(action.payload, messages);\n        let targetMessage = messages.filter(message => message.localDateSent === localDateSent && message.sender === sender);\n        targetMessage[0].sendStatus = SendStatus.SENT;\n        console.log(targetMessage);\n        return [...messages];\n      }\n\n    case \"NEW_MESSAGE\":\n      {\n        // todo sort \n        return [...messages, ...action.payload];\n      }\n\n    default:\n      throw new Error();\n  }\n}\n\nfunction Chatter() {\n  _s();\n\n  const userContext = useContext(UserContext); // TODO QUERY RESULT ADD PROPER TYPES\n\n  const existingMessages = useQuery(GET_MESSAGES_ON_LOBBY, {\n    variables: {\n      lobbyId: userContext.lobbyId\n    }\n  }); // unless yung state ng message is contained to itself\n\n  const [sendMessage, sendMessageProperties] = useMutation(SEND_MESSAGE);\n  const newMessage = useSubscription(MESSAGE_ADDED_SUBSCRIPTION, {\n    variables: {\n      lobbyId: userContext.lobbyId,\n      userId: userContext.userId\n    }\n  });\n  const chatterContainer = {\n    height: '100%',\n    display: 'flex',\n    flexDirection: 'column'\n  };\n  let initialMessages = [];\n  const [messages, dispatchMessage] = useReducer(sendMessageReducer, initialMessages);\n  const [initialized, setInitialized] = useState(false);\n\n  const handleSendMessage = message => {\n    const messageStatusIndex = messages.length;\n    dispatchMessage({\n      type: SendStatus.SENDING,\n      payload: {\n        message: message,\n        sender: userContext.userId,\n        senderUsername: userContext.username,\n        to: userContext.lobbyId,\n        sendStatus: SendStatus.SENDING,\n        index: messageStatusIndex,\n        localDateSent: new Date().getTime() + \"\",\n        callback: sendMessage\n      }\n    });\n  };\n\n  useEffect(() => {\n    var _existingMessages$dat, _existingMessages$dat2;\n\n    if (!initialized && (_existingMessages$dat = existingMessages.data) !== null && _existingMessages$dat !== void 0 && (_existingMessages$dat2 = _existingMessages$dat.getMessagesOnLobby) !== null && _existingMessages$dat2 !== void 0 && _existingMessages$dat2.success) {\n      setInitialized(true);\n      dispatchMessage({\n        type: \"FETCH_ALL\",\n        payload: existingMessages.data.getMessagesOnLobby.data\n      });\n    }\n  }, [initialized, existingMessages.data]);\n  useEffect(() => {\n    if (sendMessageProperties !== null && sendMessageProperties !== void 0 && sendMessageProperties.data) {\n      let {\n        message,\n        localDateSent\n      } = sendMessageProperties.data.addMessage;\n      dispatchMessage({\n        type: SendStatus.SENT,\n        payload: { ...message,\n          localDateSent,\n          sender: message.from.id\n        }\n      });\n    }\n\n    if (sendMessageProperties !== null && sendMessageProperties !== void 0 && sendMessageProperties.error) {\n      console.log('ERROR HAS OCCURED');\n    }\n  }, [sendMessageProperties.data, sendMessageProperties === null || sendMessageProperties === void 0 ? void 0 : sendMessageProperties.error]);\n  useEffect(() => {\n    var _newMessage$data;\n\n    // todo add types\n    if (newMessage !== null && newMessage !== void 0 && (_newMessage$data = newMessage.data) !== null && _newMessage$data !== void 0 && _newMessage$data.messageAdded) dispatchMessage({\n      type: \"NEW_MESSAGE\",\n      payload: newMessage.data.messageAdded.messages\n    });\n  }, [newMessage]);\n  return /*#__PURE__*/_jsxDEV(Box, {\n    sx: chatterContainer,\n    children: [/*#__PURE__*/_jsxDEV(Messages, {\n      messages: messages\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 141,\n      columnNumber: 4\n    }, this), /*#__PURE__*/_jsxDEV(Divider, {}, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 142,\n      columnNumber: 4\n    }, this), /*#__PURE__*/_jsxDEV(Sender, {\n      handleSendMessage: handleSendMessage\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 143,\n      columnNumber: 4\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 140,\n    columnNumber: 3\n  }, this);\n}\n\n_s(Chatter, \"SGnaJimfxUUr5KfyLl1gotYzLM8=\", false, function () {\n  return [useQuery, useMutation, useSubscription];\n});\n\n_c = Chatter;\nexport default Chatter;\n\nvar _c;\n\n$RefreshReg$(_c, \"Chatter\");","map":{"version":3,"names":["useContext","useEffect","useReducer","useState","Box","Divider","Messages","Sender","SendStatus","useMutation","useQuery","useSubscription","GET_MESSAGES_ON_LOBBY","MESSAGE_ADDED_SUBSCRIPTION","SEND_MESSAGE","UserContext","sendMessageReducer","state","action","messages","console","log","payload","type","map","message","date","Date","sender","from","id","senderUsername","username","to","sendStatus","SENT","FAILED","SENDING","localDateSent","push","callback","variables","targetMessage","filter","Error","Chatter","userContext","existingMessages","lobbyId","sendMessage","sendMessageProperties","newMessage","userId","chatterContainer","height","display","flexDirection","initialMessages","dispatchMessage","initialized","setInitialized","handleSendMessage","messageStatusIndex","length","index","getTime","data","getMessagesOnLobby","success","addMessage","error","messageAdded"],"sources":["/home/xeg/dev/chatter-web/frontend/react/chatter-react/src/components/Chatter/Chatter.tsx"],"sourcesContent":["import { useContext, useEffect, useReducer, useState } from 'react';\nimport Box from '@mui/material/Box';\nimport { Divider, SxProps } from '@mui/material';\nimport Messages from './Messages';\nimport Sender from './Sender';\nimport Message from './interface/Message';\nimport SendStatus from './interface/SendStatus';\nimport { QueryResult, useMutation, useQuery, useSubscription } from '@apollo/client';\nimport { GET_MESSAGES_ON_LOBBY, MESSAGE_ADDED_SUBSCRIPTION, SEND_MESSAGE } from '../Queries/Chatter';\nimport { UserContext } from '../Layout/Layout';\n\ntype MESSAGEACTIONTYPE = \n\t| {type: \"FETCH_ALL\", payload: any } // todo change proper types\n\t| {type: SendStatus.FAILED, payload: Message & {localDateSent: string} }\n\t| {type: SendStatus.SENDING, payload: Message & {index: number, callback: Function} }\n\t| {type: SendStatus.SENT, payload: Message & {localDateSent: string } }\n\t| {type: \"NEW_MESSAGE\", payload: Message[]} \n\n\nfunction sendMessageReducer(state: Message[], action: MESSAGEACTIONTYPE): Message[] {\n\tlet messages = state;\n\tconsole.log(action.payload);\n\tswitch(action.type) {\n\t\tcase \"FETCH_ALL\":\n\t\t\treturn action.payload.map((message: any): Message => {\n\t\t\t\treturn {\n\t\t\t\t\tdate: new Date(+message.date),\n\t\t\t\t\tmessage: message.message,\n\t\t\t\t\tsender: message.from.id,\n\t\t\t\t\tsenderUsername: message.from.username,\n\t\t\t\t\tto: \"Lobby\",\n\t\t\t\t\tsendStatus: SendStatus.SENT\n\t\t\t\t}\n\t\t\t})\n\t\tcase SendStatus.FAILED:\n\t\t\treturn {} as Message[];\n\t\tcase SendStatus.SENDING: {\n\t\t\tlet {to, sender, message, localDateSent} = action.payload;\n\t\t\tmessages.push(action.payload);\n\t\t\taction.payload.callback({\n\t\t\t\tvariables: {\n\t\t\t\t\tto,\n\t\t\t\t\tfrom: sender,\n\t\t\t\t\tmessage,\n\t\t\t\t\tlocalDateSent\n\t\t\t\t}\n\t\t\t});\n\t\t\treturn [...messages]\n\t\t}\n\t\tcase SendStatus.SENT: {\n\t\t\tlet { localDateSent, sender } = action.payload;\n\t\t\tconsole.log(action.payload, messages)\n\t\t\tlet targetMessage = messages.filter((message) => (\n\t\t\t\tmessage.localDateSent === localDateSent && message.sender === sender\n\t\t\t));\n\t\t\ttargetMessage[0].sendStatus = SendStatus.SENT;\n\t\t\tconsole.log(targetMessage)\n\t\t\treturn [...messages]\n\t\t}\n\t\tcase \"NEW_MESSAGE\": {\n\t\t\t// todo sort \n\t\t\treturn [...messages, ...action.payload];\n\t\t}\n\t\tdefault:\n\t\t\tthrow new Error();\n\t}\n}\n\nfunction Chatter() {\n\tconst userContext = useContext(UserContext);\n\n\t// TODO QUERY RESULT ADD PROPER TYPES\n\tconst existingMessages: QueryResult<any, any> = useQuery(GET_MESSAGES_ON_LOBBY, {\n\t\tvariables: {\n\t\t\tlobbyId: userContext.lobbyId\n\t\t}\n\t});\n\n\t// unless yung state ng message is contained to itself\n\tconst [sendMessage, sendMessageProperties] = useMutation(SEND_MESSAGE);\n\n\tconst newMessage = useSubscription(MESSAGE_ADDED_SUBSCRIPTION, {\n\t\tvariables: {\n\t\t\tlobbyId: userContext.lobbyId,\n\t\t\tuserId: userContext.userId\n\t\t}\n\t});\n\n\tconst chatterContainer: SxProps = {\n\t\theight: '100%',\n\t\tdisplay: 'flex',\n\t\tflexDirection: 'column',\n\t}\n\n\tlet initialMessages: Message[] = [] as Message[];\n\tconst [messages, dispatchMessage] = useReducer(sendMessageReducer, initialMessages);\n\tconst [initialized, setInitialized] = useState<boolean>(false);\n\n\tconst handleSendMessage = (message: string) => {\n\t\tconst messageStatusIndex: number = messages.length;\n\n\t\tdispatchMessage({ type: SendStatus.SENDING, payload: {\n\t\t\t\tmessage: message,\n\t\t\t\tsender: userContext.userId,\n\t\t\t\tsenderUsername: userContext.username,\n\t\t\t\tto: userContext.lobbyId,\n\t\t\t\tsendStatus: SendStatus.SENDING,\n\t\t\t\tindex: messageStatusIndex,\n\t\t\t\tlocalDateSent: new Date().getTime()+\"\",\n\t\t\t\tcallback: sendMessage\n\t\t\t} \n\t\t});\n\t}\n\n\tuseEffect(() => {\n\t\tif (!initialized && existingMessages.data?.getMessagesOnLobby?.success) {\n\t\t\tsetInitialized(true);\n\t\t\tdispatchMessage({type: \"FETCH_ALL\", payload: existingMessages.data.getMessagesOnLobby.data});\n\t\t}\n\t}, [initialized, existingMessages.data]);\n\n\tuseEffect(() => {\n\t\tif (sendMessageProperties?.data) {\n\t\t\tlet { message, localDateSent } = sendMessageProperties.data.addMessage;\n\t\t\tdispatchMessage({type: SendStatus.SENT, payload: {...message, localDateSent, sender: message.from.id }})\n\t\t}\n\n\t\tif (sendMessageProperties?.error) {\n\t\t\tconsole.log('ERROR HAS OCCURED');\n\t\t}\n\t}, [sendMessageProperties.data, sendMessageProperties?.error])\n\n\tuseEffect(() => {\n\t\t// todo add types\n\t\tif (newMessage?.data?.messageAdded)\n\t\t\tdispatchMessage({type: \"NEW_MESSAGE\", payload: newMessage.data.messageAdded.messages as Message[]})\n\t}, [newMessage]);\n\n\treturn (\n\t\t<Box sx={chatterContainer}>\n\t\t\t<Messages messages={messages}></Messages>\n\t\t\t<Divider></Divider>\n\t\t\t<Sender handleSendMessage={handleSendMessage}></Sender>\n\t\t</Box>\n\t);\n}\n\nexport default Chatter;"],"mappings":"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"},"metadata":{},"sourceType":"module"}